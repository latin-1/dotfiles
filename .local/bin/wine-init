#!/bin/bash
set -eo pipefail

export WINE="${WINE:-wine}"
export WINESERVER="${WINESERVER:-${WINE}server}"
export WINEPREFIX="${WINEPREFIX:-$HOME/.wine}"
export WINEARCH="${WINEARCH:-win64}"
export WINEDLLOVERRIDES="winemenubuilder.exe=d"

"$WINE" wineboot --init
"$WINESERVER" --wait

if pushd "$WINEPREFIX/drive_c/users/$USER" > /dev/null; then
  for name in *; do
    if [[ -h "./$name" ]]; then
      rm -f "./$name"
      mkdir "./$name"
    fi
  done
  popd > /dev/null
fi

"$WINE" regedit /s - << EOF
Windows Registry Editor Version 5.00

[HKEY_CURRENT_USER\\Software\\Wine\\DllOverrides]
"winemenubuilder.exe"=""
EOF
"$WINESERVER" --wait
